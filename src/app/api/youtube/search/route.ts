import { NextRequest, NextResponse } from 'next/server';

import { getAuthInfoFromCookie } from '@/lib/auth';
import { getConfig } from '@/lib/config';
import { db } from '@/lib/db';
import { clearYouTubeSearchCache } from '@/lib/youtube-cache';

export const runtime = 'nodejs';

// YouTube Data API v3 ÈÖçÁΩÆ
const YOUTUBE_API_BASE = 'https://www.googleapis.com/youtube/v3';

// ÂÜÖÂÆπÁ±ªÂûãÂà∞ÊêúÁ¥¢ÂÖ≥ÈîÆËØçÁöÑÊò†Â∞Ñ
const getContentTypeQuery = (originalQuery: string, contentType: string): string => {
  if (contentType === 'all') return originalQuery;
  
  const typeKeywords = {
    music: ['music', 'song', 'audio', 'MV', 'cover', 'live'],
    movie: ['movie', 'film', 'trailer', 'cinema', 'full movie'],
    educational: ['tutorial', 'education', 'learn', 'how to', 'guide', 'course'],
    gaming: ['gaming', 'gameplay', 'game', 'walkthrough', 'review'],
    sports: ['sports', 'football', 'basketball', 'soccer', 'match', 'game'],
    news: ['news', 'breaking', 'report', 'today', 'latest']
  };
  
  const keywords = typeKeywords[contentType as keyof typeof typeKeywords] || [];
  if (keywords.length > 0) {
    // ÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™ÂÖ≥ÈîÆËØçÊ∑ªÂä†Âà∞ÊêúÁ¥¢‰∏≠
    const randomKeyword = keywords[Math.floor(Math.random() * keywords.length)];
    return `${originalQuery} ${randomKeyword}`;
  }
  
  return originalQuery;
};

// Ê®°ÊãüÊêúÁ¥¢Êï∞ÊçÆÔºàÂΩìÊ≤°ÊúâÁúüÂÆûAPI KeyÊó∂‰ΩøÁî®Ôºâ
const mockSearchResults = [
  {
    id: { videoId: 'dQw4w9WgXcQ' },
    snippet: {
      title: 'Never Gonna Give You Up',
      description: 'The official video for "Never Gonna Give You Up" by Rick Astley',
      thumbnails: {
        medium: {
          url: 'https://i.ytimg.com/vi/dQw4w9WgXcQ/mqdefault.jpg',
          width: 320,
          height: 180
        }
      },
      channelTitle: 'Rick Astley',
      publishedAt: '2009-10-25T06:57:33Z',
      channelId: 'UCuAXFkgsw1L7xaCfnd5JJOw'
    }
  },
  {
    id: { videoId: '9bZkp7q19f0' },
    snippet: {
      title: 'GANGNAM STYLE',
      description: 'PSY - GANGNAM STYLE(Í∞ïÎÇ®Ïä§ÌÉÄÏùº) M/V',
      thumbnails: {
        medium: {
          url: 'https://i.ytimg.com/vi/9bZkp7q19f0/mqdefault.jpg',
          width: 320,
          height: 180
        }
      },
      channelTitle: 'officialpsy',
      publishedAt: '2012-07-15T08:34:21Z',
      channelId: 'UCrDkAvF9ZRMyvALrOFqOZ5A'
    }
  },
  {
    id: { videoId: 'kJQP7kiw5Fk' },
    snippet: {
      title: 'Despacito',
      description: 'Luis Fonsi - Despacito ft. Daddy Yankee',
      thumbnails: {
        medium: {
          url: 'https://i.ytimg.com/vi/kJQP7kiw5Fk/mqdefault.jpg',
          width: 320,
          height: 180
        }
      },
      channelTitle: 'LuisFonsiVEVO',
      publishedAt: '2017-01-12T19:06:32Z',
      channelId: 'UCAxjGjCSj8wLGhcMQTKgxNw'
    }
  },
  {
    id: { videoId: 'fJ9rUzIMcZQ' },
    snippet: {
      title: 'Bohemian Rhapsody',
      description: 'Queen ‚Äì Bohemian Rhapsody (Official Video Remastered)',
      thumbnails: {
        medium: {
          url: 'https://i.ytimg.com/vi/fJ9rUzIMcZQ/mqdefault.jpg',
          width: 320,
          height: 180
        }
      },
      channelTitle: 'Queen Official',
      publishedAt: '2008-08-01T14:54:09Z',
      channelId: 'UCwK2Grm574W1u-sBzLikldQ'
    }
  },
  {
    id: { videoId: 'OPf0YbXqDm0' },
    snippet: {
      title: 'Uptown Funk',
      description: 'Mark Ronson - Uptown Funk ft. Bruno Mars',
      thumbnails: {
        medium: {
          url: 'https://i.ytimg.com/vi/OPf0YbXqDm0/mqdefault.jpg',
          width: 320,
          height: 180
        }
      },
      channelTitle: 'Mark Ronson',
      publishedAt: '2015-01-20T16:00:00Z',
      channelId: 'UCqC9s1NAkvPidFpGBewPs5w'
    }
  },
  {
    id: { videoId: '09R8_2nJtjg' },
    snippet: {
      title: 'Happy',
      description: 'Pharrell Williams - Happy',
      thumbnails: {
        medium: {
          url: 'https://i.ytimg.com/vi/09R8_2nJtjg/mqdefault.jpg',
          width: 320,
          height: 180
        }
      },
      channelTitle: 'Pharrell Williams',
      publishedAt: '2014-06-08T16:00:00Z',
      channelId: 'UCoY1B2j6F5aO4gJX135kX5Q'
    }
  }
];

export async function GET(request: NextRequest) {
  const authInfo = getAuthInfoFromCookie(request);
  if (!authInfo || !authInfo.username) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const { searchParams } = new URL(request.url);
  const query = searchParams.get('q');
  const contentType = searchParams.get('contentType') || 'all';
  const order = searchParams.get('order') || 'relevance';
  
  if (!query) {
    return NextResponse.json({ error: 'ÊêúÁ¥¢ÂÖ≥ÈîÆËØç‰∏çËÉΩ‰∏∫Á©∫' }, { status: 400 });
  }

  try {
    // Ëé∑ÂèñYouTubeÈÖçÁΩÆ
    const config = await getConfig();
    const youtubeConfig = config.YouTubeConfig;

    // Ê£ÄÊü•YouTubeÂäüËÉΩÊòØÂê¶ÂêØÁî®
    if (!youtubeConfig?.enabled) {
      return NextResponse.json({
        success: false,
        error: 'YouTubeÊêúÁ¥¢ÂäüËÉΩÊú™ÂêØÁî®'
      }, { 
        status: 400,
        headers: {
          'Cache-Control': 'no-store, no-cache, must-revalidate, proxy-revalidate',
          'Expires': '0',
          'Pragma': 'no-cache',
          'Surrogate-Control': 'no-store'
        }
      });
    }

    const maxResults = Math.min(parseInt(searchParams.get('maxResults') || String(youtubeConfig.maxResults || 25)), 50);

    // YouTubeÊêúÁ¥¢ÁºìÂ≠òÔºö60ÂàÜÈíüÔºàÂõ†‰∏∫YouTubeÂÜÖÂÆπÊõ¥Êñ∞È¢ëÁéáÁõ∏ÂØπËæÉ‰ΩéÔºâ
    const YOUTUBE_CACHE_TIME = 60 * 60; // 60ÂàÜÈíüÔºàÁßíÔºâ
    const enabledRegionsStr = (youtubeConfig.enabledRegions || []).sort().join(',') || 'none';
    const enabledCategoriesStr = (youtubeConfig.enabledCategories || []).sort().join(',') || 'none';
    // ÁºìÂ≠òkeyÂåÖÂê´ÂäüËÉΩÁä∂ÊÄÅ„ÄÅÊºîÁ§∫Ê®°Âºè„ÄÅÊúÄÂ§ßÁªìÊûúÊï∞„ÄÅÂÜÖÂÆπÁ±ªÂûã„ÄÅÊéíÂ∫èÔºåÁ°Æ‰øùÈÖçÁΩÆÂèòÂåñÊó∂ÁºìÂ≠òÈöîÁ¶ª
    const cacheKey = `youtube-search-${youtubeConfig.enabled}-${youtubeConfig.enableDemo}-${maxResults}-${encodeURIComponent(query)}-${contentType}-${order}-${enabledRegionsStr}-${enabledCategoriesStr}`;
    
    console.log(`üîç Ê£ÄÊü•YouTubeÊêúÁ¥¢ÁºìÂ≠ò: ${cacheKey}`);
    
    // ÊúçÂä°Á´ØÁõ¥Êé•Ë∞ÉÁî®Êï∞ÊçÆÂ∫ìÔºà‰∏çÁî®ClientCacheÔºåÈÅøÂÖçHTTPÂæ™ÁéØË∞ÉÁî®Ôºâ
    try {
      const cached = await db.getCache(cacheKey);
      if (cached) {
        console.log(`‚úÖ YouTubeÊêúÁ¥¢ÁºìÂ≠òÂëΩ‰∏≠(Êï∞ÊçÆÂ∫ì): "${query}"`);
        return NextResponse.json({
          ...cached,
          fromCache: true,
          cacheSource: 'database',
          cacheTimestamp: new Date().toISOString()
        });
      }
      
      console.log(`‚ùå YouTubeÊêúÁ¥¢ÁºìÂ≠òÊú™ÂëΩ‰∏≠: "${query}"`);
    } catch (cacheError) {
      console.warn('YouTubeÊêúÁ¥¢ÁºìÂ≠òËØªÂèñÂ§±Ë¥•:', cacheError);
      // ÁºìÂ≠òÂ§±Ë¥•‰∏çÂΩ±Âìç‰∏ªÊµÅÁ®ãÔºåÁªßÁª≠ÊâßË°å
    }

    // Â¶ÇÊûúÂêØÁî®ÊºîÁ§∫Ê®°ÂºèÊàñÊ≤°ÊúâÈÖçÁΩÆAPI KeyÔºåËøîÂõûÊ®°ÊãüÊï∞ÊçÆ
    if (youtubeConfig.enableDemo || !youtubeConfig.apiKey) {
      // Ê†πÊçÆÊêúÁ¥¢ÂÖ≥ÈîÆËØçËøáÊª§ÂíåÂÆöÂà∂Ê®°ÊãüÁªìÊûú
      let filteredResults = [...mockSearchResults];
      
      // Â¶ÇÊûúÊúâÊêúÁ¥¢ÂÖ≥ÈîÆËØçÔºåÊ†πÊçÆÂÖ≥ÈîÆËØçË∞ÉÊï¥Ê®°ÊãüÁªìÊûúÁöÑÊ†áÈ¢ò
      if (query && query.trim()) {
        const trimmedQuery = query.trim().toLowerCase();
        
        // Ê†πÊçÆÊêúÁ¥¢ÂÖ≥ÈîÆËØçÂÆöÂà∂Ê®°ÊãüÁªìÊûúÊ†áÈ¢ò
        filteredResults = filteredResults.map(video => {
          // Ê£ÄÊü•ËßÜÈ¢ëÊ†áÈ¢òÊòØÂê¶‰∏éÊêúÁ¥¢ÂÖ≥ÈîÆËØçÁõ∏ÂÖ≥
          const isRelevant = video.snippet.title.toLowerCase().includes(trimmedQuery) || 
                             video.snippet.channelTitle.toLowerCase().includes(trimmedQuery);
          
          // Â¶ÇÊûúÁõ∏ÂÖ≥Ôºå‰øùÊåÅÂéüÊ†∑ÔºõÂ¶ÇÊûú‰∏çÁõ∏ÂÖ≥ÔºåÂ∞ÜÊêúÁ¥¢ÂÖ≥ÈîÆËØçÊ∑ªÂä†Âà∞Ê†áÈ¢òÂâç
          const title = isRelevant 
            ? video.snippet.title 
            : `${query} - ${video.snippet.title}`;
          
          return {
            ...video,
            snippet: {
              ...video.snippet,
              title: title
            }
          };
        });
        
        // Ëøõ‰∏ÄÊ≠•ËøáÊª§ÔºåÂè™‰øùÁïô‰∏éÊêúÁ¥¢ÂÖ≥ÈîÆËØçÁõ∏ÂÖ≥ÁöÑËßÜÈ¢ë
        filteredResults = filteredResults.filter(video => {
          const title = video.snippet.title.toLowerCase();
          const channel = video.snippet.channelTitle.toLowerCase();
          const description = video.snippet.description.toLowerCase();
          
          // Ê£ÄÊü•Ê†áÈ¢ò„ÄÅÈ¢ëÈÅìÂêçÊàñÊèèËø∞‰∏≠ÊòØÂê¶ÂåÖÂê´ÊêúÁ¥¢ÂÖ≥ÈîÆËØç
          return title.includes(trimmedQuery) || 
                 channel.includes(trimmedQuery) || 
                 description.includes(trimmedQuery);
        });
      }
      
      // Ê†πÊçÆÂÜÖÂÆπÁ±ªÂûãËøõ‰∏ÄÊ≠•ËøáÊª§
      if (contentType !== 'all') {
        // ÂÜÖÂÆπÁ±ªÂûãËøáÊª§ÈÄªËæëÔºàÂü∫‰∫éÊ†áÈ¢òÂÖ≥ÈîÆËØçÔºâ
        const typeFilters = {
          music: ['music', 'song', 'mv', 'audio', 'official'],
          movie: ['movie', 'film', 'trailer', 'cinema'],
          educational: ['tutorial', 'guide', 'how', 'learn', 'education'],
          gaming: ['game', 'gaming', 'playthrough', 'review'],
          sports: ['sports', 'football', 'basketball', 'soccer', 'match'],
          news: ['news', 'report', 'breaking', 'today', 'latest']
        };
        
        const filterKeywords = typeFilters[contentType as keyof typeof typeFilters] || [];
        if (filterKeywords.length > 0) {
          filteredResults = filteredResults.filter(video => 
            filterKeywords.some(keyword => 
              video.snippet.title.toLowerCase().includes(keyword) ||
              video.snippet.description.toLowerCase().includes(keyword) ||
              video.snippet.channelTitle.toLowerCase().includes(keyword)
            )
          );
        }
      }
      
      const finalResults = filteredResults.slice(0, maxResults);
      
      const responseData = {
        success: true,
        videos: finalResults,
        total: finalResults.length,
        query: query,
        source: 'demo',
        warning: youtubeConfig.enableDemo ? 'ÂΩìÂâç‰∏∫ÊºîÁ§∫Ê®°ÂºèÔºåÊòæÁ§∫Ê®°ÊãüÊï∞ÊçÆ' : 'API KeyÊú™ÈÖçÁΩÆÔºåÊòæÁ§∫Ê®°ÊãüÊï∞ÊçÆ„ÄÇËØ∑Âú®ÁÆ°ÁêÜÂêéÂè∞ÈÖçÁΩÆYouTube API Key‰ª•Ëé∑ÂèñÁúüÂÆûÊêúÁ¥¢ÁªìÊûú'
      };

      // ÊúçÂä°Á´ØÁõ¥Êé•‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ìÔºà‰∏çÁî®ClientCacheÔºåÈÅøÂÖçHTTPÂæ™ÁéØË∞ÉÁî®Ôºâ
      try {
        await db.setCache(cacheKey, responseData, YOUTUBE_CACHE_TIME);
        console.log(`üíæ YouTubeÊêúÁ¥¢ÊºîÁ§∫ÁªìÊûúÂ∑≤ÁºìÂ≠ò(Êï∞ÊçÆÂ∫ì): "${query}" - ${responseData.videos.length} ‰∏™ÁªìÊûú, TTL: ${YOUTUBE_CACHE_TIME}s`);
      } catch (cacheError) {
        console.warn('YouTubeÊêúÁ¥¢ÁºìÂ≠ò‰øùÂ≠òÂ§±Ë¥•:', cacheError);
      }
      
      return NextResponse.json(responseData);
    }

    // ‰ΩøÁî®ÁúüÂÆûÁöÑYouTube API
    const enhancedQuery = getContentTypeQuery(query.trim(), contentType);
    const searchUrl = `${YOUTUBE_API_BASE}/search?` +
      `key=${youtubeConfig.apiKey}&` +
      `q=${encodeURIComponent(enhancedQuery)}&` +
      `part=snippet&` +
      `type=video&` +
      `maxResults=${maxResults}&` +
      `order=${order}`;

    const response = await fetch(searchUrl);

    if (!response.ok) {
      // Ëé∑ÂèñÈîôËØØËØ¶ÁªÜ‰ø°ÊÅØ
      const errorData = await response.json().catch(() => ({}));
      console.log('YouTube APIÈîôËØØËØ¶ÊÉÖ:', errorData);
      
      let errorMessage = '';
      
      // Ê£ÄÊü•ÂÖ∑‰ΩìÁöÑÈîôËØØÁä∂ÊÄÅ
      if (response.status === 400) {
        const reason = errorData.error?.errors?.[0]?.reason;
        const message = errorData.error?.message || '';
        
        if (reason === 'keyInvalid' || message.includes('API key not valid')) {
          errorMessage = 'YouTube API KeyÊó†ÊïàÔºåËØ∑Âú®ÁÆ°ÁêÜÂêéÂè∞Ê£ÄÊü•ÈÖçÁΩÆ';
        } else if (reason === 'badRequest') {
          if (message.includes('API key')) {
            errorMessage = 'YouTube API KeyÊ†ºÂºèÈîôËØØÔºåËØ∑Âú®ÁÆ°ÁêÜÂêéÂè∞ÈáçÊñ∞ÈÖçÁΩÆ';
          } else {
            errorMessage = `YouTube APIËØ∑Ê±ÇÂèÇÊï∞ÈîôËØØ: ${message}`;
          }
        } else {
          errorMessage = `YouTube APIËØ∑Ê±ÇÈîôËØØ: ${message || 'Bad Request'}`;
        }
      } else if (response.status === 403) {
        const reason = errorData.error?.errors?.[0]?.reason;
        const message = errorData.error?.message || '';
        
        if (reason === 'quotaExceeded' || message.includes('quota')) {
          errorMessage = 'YouTube APIÈÖçÈ¢ùÂ∑≤Áî®ÂÆåÔºåËØ∑Á®çÂêéÈáçËØï';
        } else if (message.includes('not been used') || message.includes('disabled')) {
          errorMessage = 'YouTube Data API v3Êú™ÂêØÁî®ÔºåËØ∑Âú®Google Cloud Console‰∏≠ÂêØÁî®ËØ•API';
        } else if (message.includes('blocked') || message.includes('restricted')) {
          errorMessage = 'API KeyË¢´ÈôêÂà∂ËÆøÈóÆÔºåËØ∑Ê£ÄÊü•Google Cloud Console‰∏≠ÁöÑAPI KeyÈôêÂà∂ËÆæÁΩÆ';
        } else {
          errorMessage = 'YouTube APIËÆøÈóÆË¢´ÊãíÁªùÔºåËØ∑Ê£ÄÊü•API KeyÊùÉÈôêÈÖçÁΩÆ';
        }
      } else if (response.status === 401) {
        errorMessage = 'YouTube APIËÆ§ËØÅÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•API KeyÊòØÂê¶Ê≠£Á°Æ';
      } else {
        errorMessage = `YouTube APIËØ∑Ê±ÇÂ§±Ë¥• (${response.status})ÔºåËØ∑Ê£ÄÊü•API KeyÈÖçÁΩÆ`;
      }
      
      // ËøîÂõûÈîôËØØÂìçÂ∫îËÄå‰∏çÊòØÊäõÂá∫ÂºÇÂ∏∏
      return NextResponse.json({
        success: false,
        error: errorMessage
      }, { status: 400 });
    }

    const data = await response.json();
    
    // ËøáÊª§Êéâ‰∏éÊêúÁ¥¢ÂÖ≥ÈîÆËØç‰∏çÁõ∏ÂÖ≥ÁöÑËßÜÈ¢ë
    let filteredVideos = data.items || [];
    
    // Â¶ÇÊûúÊúâÊêúÁ¥¢ÂÖ≥ÈîÆËØçÔºåËøõ‰∏ÄÊ≠•ËøáÊª§ÁªìÊûú
    if (query.trim()) {
      const trimmedQuery = query.trim().toLowerCase();
      filteredVideos = filteredVideos.filter((video: any) => {
        const title = (video.snippet?.title || '').toLowerCase();
        const channel = (video.snippet?.channelTitle || '').toLowerCase();
        const description = (video.snippet?.description || '').toLowerCase();
        
        // Ê£ÄÊü•Ê†áÈ¢ò„ÄÅÈ¢ëÈÅìÂêçÊàñÊèèËø∞‰∏≠ÊòØÂê¶ÂåÖÂê´ÊêúÁ¥¢ÂÖ≥ÈîÆËØç
        return title.includes(trimmedQuery) || 
               channel.includes(trimmedQuery) || 
               description.includes(trimmedQuery);
      });
    }
    
    const responseData = {
      success: true,
      videos: filteredVideos,
      total: filteredVideos.length,
      query: query,
      source: 'youtube'
    };

    // ÊúçÂä°Á´ØÁõ¥Êé•‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ìÔºà‰∏çÁî®ClientCacheÔºåÈÅøÂÖçHTTPÂæ™ÁéØË∞ÉÁî®Ôºâ
    try {
      await db.setCache(cacheKey, responseData, YOUTUBE_CACHE_TIME);
      console.log(`üíæ YouTubeÊêúÁ¥¢APIÁªìÊûúÂ∑≤ÁºìÂ≠ò(Êï∞ÊçÆÂ∫ì): "${query}" - ${responseData.videos.length} ‰∏™ÁªìÊûú, TTL: ${YOUTUBE_CACHE_TIME}s`);
    } catch (cacheError) {
      console.warn('YouTubeÊêúÁ¥¢ÁºìÂ≠ò‰øùÂ≠òÂ§±Ë¥•:', cacheError);
    }

    console.log(`‚úÖ YouTubeÊêúÁ¥¢ÂÆåÊàê: "${query}" - ${responseData.videos.length} ‰∏™ÁªìÊûú`);
    return NextResponse.json(responseData);
    
  } catch (error) {
    console.error('YouTubeÊêúÁ¥¢Â§±Ë¥•:', error);
    
    // APIÂ§±Ë¥•Êó∂ËøîÂõûÊ®°ÊãüÊï∞ÊçÆ‰Ωú‰∏∫Â§áÁî®
    const fallbackResults = mockSearchResults.slice(0, 10).map(video => ({
      ...video,
      snippet: {
        ...video.snippet,
        title: `${query} - ${video.snippet.title}`,
      }
    }));
    
    const fallbackData = {
      success: true,
      videos: fallbackResults,
      total: fallbackResults.length,
      query: query,
      source: 'fallback'
    };

    // Â§±Ë¥•ÊÉÖÂÜµÁöÑÁºìÂ≠òÊó∂Èó¥ËÆæÁü≠‰∏ÄÁÇπÔºåÈÅøÂÖçÈïøÊó∂Èó¥ÁºìÂ≠òÈîôËØØÁä∂ÊÄÅ
    try {
      // Âú®catchÂùó‰∏≠ÈáçÊñ∞ÊûÑÂª∫ÁÆÄÂåñÁöÑcacheKey
      const fallbackCacheKey = `youtube-search-fallback-${query}`;
      await db.setCache(fallbackCacheKey, fallbackData, 5 * 60); // 5ÂàÜÈíü
      console.log(`üíæ YouTubeÊêúÁ¥¢Â§áÁî®ÁªìÊûúÂ∑≤ÁºìÂ≠ò(Êï∞ÊçÆÂ∫ì): "${query}" - ${fallbackData.videos.length} ‰∏™ÁªìÊûú, TTL: 5ÂàÜÈíü`);
    } catch (cacheError) {
      console.warn('YouTubeÊêúÁ¥¢Â§áÁî®ÁºìÂ≠ò‰øùÂ≠òÂ§±Ë¥•:', cacheError);
    }
    
    return NextResponse.json(fallbackData);
  }
}